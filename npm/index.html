<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>this.me — Runtime</title>
  <link rel="icon" href="https://res.cloudinary.com/dkwnxf6gm/image/upload/v1761276578/this.gui.npm.png" />

  <!-- this.GUI styles -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/this.gui@latest/dist/this.gui.css" crossorigin="anonymous" />
</head>
<body>
  <div id="root"></div>

  <!-- React (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>

  <!-- Some UMD bundles look for process.env.NODE_ENV -->
  <script>
    window.process = window.process || { env: {} };
    window.process.env = window.process.env || {};
    window.process.env.NODE_ENV = "production";
  </script>

  <!-- this.GUI (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/this.gui@latest/dist/this.gui.umd.js" crossorigin="anonymous"></script>

  <!-- Load this.me (ESM) and expose to window for the UMD/React runtime below -->
  <script type="module">
    import ME from "../dist/this-me.es.js";
    // Expose constructor for non-module scripts.
    window.ME = ME?.default || ME;
    window.dispatchEvent(new Event("thisme:ready"));
  </script>

  <script>
    (function () {
      const rootEl = document.getElementById('root');
      if (!rootEl) return;

      const React = window.React;
      const ReactDOM = window.ReactDOM;

      const GUI = window.GUI || null;
      const GuiProvider = GUI?.GuiProvider || GUI?.default?.GuiProvider || null;

      // this.GUI component resolver (best-effort)
      const Layout =
        GUI?.Layout ||
        GUI?.default?.Layout ||
        GUI?.Theme?.Layout ||
        GUI?.default?.Theme?.Layout ||
        null;

      const Hero =
        GUI?.Hero ||
        GUI?.molecules?.Hero ||
        GUI?.molecules?.Hero2 ||
        GUI?.default?.Hero ||
        GUI?.default?.Hero2 ||
        null;

      const Box = GUI?.Box || GUI?.atoms?.Box || GUI?.default?.Box || GUI?.default?.atoms?.Box || null;
      const Button = GUI?.Button || GUI?.atoms?.Button || GUI?.default?.Button || GUI?.default?.atoms?.Button || null;
      const TextField = GUI?.TextField || GUI?.atoms?.TextField || GUI?.default?.TextField || GUI?.default?.atoms?.TextField || null;
      const Typography = GUI?.Typography || GUI?.atoms?.Typography || GUI?.default?.Typography || GUI?.default?.atoms?.Typography || null;
      const Divider = GUI?.Divider || GUI?.atoms?.Divider || GUI?.default?.Divider || GUI?.default?.atoms?.Divider || null;

      function UIBox(props) {
        const Comp = Box || 'div';
        return React.createElement(Comp, props);
      }
      function UITypography(props) {
        const Comp = Typography || 'div';
        return React.createElement(Comp, props);
      }
      function UIDivider(props) {
        const Comp = Divider || 'hr';
        return React.createElement(Comp, props);
      }
      function UIButton(props) {
        const Comp = Button || 'button';
        return React.createElement(Comp, props);
      }
      function UITextField(props) {
        if (TextField) return React.createElement(TextField, props);
        const { label, value, onChange, placeholder, type, inputMode } = props;
        return React.createElement(
          'label',
          { style: { display: 'grid', gap: 6 } },
          label ? React.createElement('div', { style: { fontSize: 12, opacity: 0.85 } }, label) : null,
          React.createElement('input', { value, onChange, placeholder, type: type || 'text', inputMode })
        );
      }

      function safeJson(x) {
        try { return JSON.stringify(x, null, 2); } catch (e) { return String(x); }
      }

      function getSTM(me) {
        const v = me?.shortTermMemory ?? me?._shortTermMemory;
        return Array.isArray(v) ? v : [];
      }

      function App() {
        const [ready, setReady] = React.useState(false);
        const [err, setErr] = React.useState(null);
        const meRef = React.useRef(null);

        // form state
        const [username, setUsername] = React.useState('jabellae');
        const [orgName, setOrgName] = React.useState('MiOrg');
        const [trucks, setTrucks] = React.useState('10');
        const [trailers, setTrailers] = React.useState('20');
        const [driverName, setDriverName] = React.useState('');
        const [driverPhone, setDriverPhone] = React.useState('');

        const [peek, setPeek] = React.useState({
          identity: null,
          org: null,
          counts: null,
          drivers: null,
          stmTail: [],
          debug: null,
        });

        React.useEffect(() => {
          function boot() {
            try {
              const ME_CTOR = window.ME && (window.ME.default || window.ME);
              if (!ME_CTOR || typeof ME_CTOR !== 'function') {
                setErr('this.me ESM loaded but did not expose a constructor on window.ME. Check ../dist/this-me.es.js exports.');
                return;
              }
              meRef.current = new ME_CTOR();
              setReady(true);
              refreshPeek();
            } catch (e) {
              setErr(String(e?.message || e));
            }
          }

          // if module already loaded, boot immediately
          if (window.ME) boot();
          // otherwise wait for event
          const onReady = () => boot();
          window.addEventListener('thisme:ready', onReady);
          return () => window.removeEventListener('thisme:ready', onReady);
          // eslint-disable-next-line react-hooks/exhaustive-deps
        }, []);

        function refreshPeek() {
          const me = meRef.current;
          if (!me) return;
          const stm = getSTM(me);
          const tail = stm.slice(Math.max(0, stm.length - 10));
          setPeek({
            identity: me('__id') ?? null,
            org: {
              name: me('org.name'),
              kind: me('org.kind'),
            },
            counts: {
              trucks: me('org.assets.trucks.count'),
              trailers: me('org.assets.trailers.count'),
              drivers: me('org.contacts.drivers.count'),
            },
            drivers: me('org.contacts.drivers.list'),
            stmTail: tail,
            debug: {
              hasGUI: !!GUI,
              hasGuiProvider: !!GuiProvider,
              hasLayout: !!Layout,
              hasHero: !!Hero,
              METype: typeof (window.ME?.default || window.ME),
            },
          });
        }

        function doClaimIdentity() {
          const me = meRef.current;
          if (!me) return;
          try {
            me['@'](username);
            refreshPeek();
          } catch (e) {
            alert('Identity error: ' + String(e?.message || e));
          }
        }

        function doSetupOrg() {
          const me = meRef.current;
          if (!me) return;
          me.org.name(orgName);
          me.org.kind('logistics');
          refreshPeek();
        }

        function doSetCounts() {
          const me = meRef.current;
          if (!me) return;
          const t = Number(trucks);
          const r = Number(trailers);
          if (!Number.isFinite(t) || !Number.isFinite(r)) {
            alert('Counts must be numbers');
            return;
          }
          me.org.assets.trucks.count(t);
          me.org.assets.trailers.count(r);
          refreshPeek();
        }

        function doInitContactsSecret() {
          const me = meRef.current;
          if (!me) return;
          // Mark contacts scope as secret
          me.org.contacts['_']('contacts-secret');
          refreshPeek();
        }

        function doAddDriver() {
          const me = meRef.current;
          if (!me) return;
          const name = (driverName || '').trim();
          const phone = (driverPhone || '').trim();
          if (!name) {
            alert('Driver name required');
            return;
          }
          const current = me('org.contacts.drivers.list');
          const list = Array.isArray(current) ? current.slice() : [];
          list.push({ name, phone: phone || undefined, role: 'truck-operator' });
          me.org.contacts.drivers.list(list);
          me.org.contacts.drivers.count(list.length);
          setDriverName('');
          setDriverPhone('');
          refreshPeek();
        }

        function doCreateSchemas() {
          const me = meRef.current;
          if (!me) return;
          me.schemas.truck.v1({
            type: 'Truck',
            version: 1,
            required: ['plate', 'status'],
            optional: ['vin', 'year', 'odometer', 'assignedDriver', 'assignedTrailer'],
          });
          me.schemas.trailer.v1({
            type: 'Trailer',
            version: 1,
            required: ['serial', 'status'],
            optional: ['capacityKg', 'assignedTruck'],
          });
          me.schemas.driver.v1({
            type: 'Driver',
            version: 1,
            required: ['name'],
            optional: ['phone', 'license', 'primaryTruck'],
          });
          refreshPeek();
        }

        function doExportThoughts() {
          const me = meRef.current;
          if (!me) return;
          const stm = getSTM(me);
          const blob = new Blob([safeJson(stm)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'this-me.thoughts.json';
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 1500);
        }

        if (err) {
          return React.createElement(
            UIBox,
            { sx: { p: 3 } },
            React.createElement(UITypography, { variant: 'h6', sx: { fontWeight: 900 } }, '❌ Cannot start'),
            React.createElement('pre', null, String(err))
          );
        }

        const header = React.createElement(
          UIBox,
          { sx: { display: 'grid', gap: 0.5 } },
          React.createElement(UITypography, { variant: 'h5', sx: { fontWeight: 900, letterSpacing: '-0.2px' } }, 'this.me — Designer'),
          React.createElement(UITypography, { variant: 'body2', sx: { opacity: 0.8 } }, ready ? '✅ ME loaded' : '… loading'),
          React.createElement(UITypography, { variant: 'body2', sx: { opacity: 0.8 } }, 'Identity → Org → Fleet → Contacts → Schemas')
        );

        const form = React.createElement(
          UIBox,
          { sx: { display: 'grid', gap: 1.5 } },

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, '1) Identity'),
          React.createElement(UITextField, { label: 'username', value: username, onChange: (e) => setUsername(e.target.value), placeholder: 'jabellae' }),
          React.createElement(UIButton, { onClick: doClaimIdentity }, 'Claim (@)'),

          React.createElement(UIDivider, null),

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, '2) Organization'),
          React.createElement(UITextField, { label: 'org name', value: orgName, onChange: (e) => setOrgName(e.target.value), placeholder: 'MiOrg' }),
          React.createElement(UIButton, { onClick: doSetupOrg }, 'Write org'),

          React.createElement(UIDivider, null),

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, '3) Fleet counts'),
          React.createElement(UITextField, { label: 'trucks', value: trucks, onChange: (e) => setTrucks(e.target.value), inputMode: 'numeric' }),
          React.createElement(UITextField, { label: 'trailers', value: trailers, onChange: (e) => setTrailers(e.target.value), inputMode: 'numeric' }),
          React.createElement(UIButton, { onClick: doSetCounts }, 'Write counts'),

          React.createElement(UIDivider, null),

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, '4) Contacts'),
          React.createElement(UIButton, { onClick: doInitContactsSecret }, 'Make contacts secret (_)'),
          React.createElement(UITextField, { label: 'driver name', value: driverName, onChange: (e) => setDriverName(e.target.value), placeholder: 'Mario' }),
          React.createElement(UITextField, { label: 'driver phone', value: driverPhone, onChange: (e) => setDriverPhone(e.target.value), placeholder: '+52...' }),
          React.createElement(UIButton, { onClick: doAddDriver }, 'Add driver'),

          React.createElement(UIDivider, null),

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, '5) Schemas'),
          React.createElement(UIButton, { onClick: doCreateSchemas }, 'Create base schemas'),

          React.createElement(UIDivider, null),

          React.createElement(UITypography, { variant: 'h6', sx: { mt: 1, fontWeight: 900 } }, 'Utilities'),
          React.createElement(UIButton, { onClick: refreshPeek }, 'Refresh peek'),
          React.createElement(UIButton, { onClick: doExportThoughts }, 'Download shortTermMemory')
        );

        const inspector = React.createElement(
          UIBox,
          { sx: { display: 'grid', gap: 1 } },
          React.createElement(UITypography, { variant: 'h6', sx: { fontWeight: 900 } }, 'Peek (me("path"))'),
          React.createElement('pre', null, safeJson(peek)),
          React.createElement(UITypography, { variant: 'h6', sx: { mt: 2, fontWeight: 900 } }, 'Last 10 thoughts'),
          React.createElement('pre', null, safeJson(peek.stmTail))
        );

        const content = React.createElement(
          UIBox,
          { sx: { p: 3, display: 'grid', gap: 2 } },
          header,
          React.createElement(
            UIBox,
            { sx: { display: 'grid', gridTemplateColumns: { xs: '1fr', md: '420px 1fr' }, gap: 3, mt: 1 } },
            React.createElement(UIBox, null, form),
            React.createElement(UIBox, null, inspector)
          )
        );

        const contentWithHero = Hero
          ? React.createElement(
              Hero,
              {
                backgroundSrc: 'https://res.cloudinary.com/dkwnxf6gm/image/upload/v1760775368/1cb1d36b58024a2b3ff2be667366d09e78110bea1e5ef72174aedd6174a1bbcc_hs2tpc.png',
                backgroundType: 'image',
                blur: 'light',
                customColor: 'rgba(13, 36, 52, 0.70)',
              },
              content
            )
          : content;

        if (Layout) {
          return React.createElement(
            Layout,
            {
              leftSidebarConfig: {
                initialView: 'rail',
                elements: [
                  { type: 'link', props: { label: 'Home', icon: 'home', href: 'https://neurons-me.github.io/' } },
                  { type: 'link', props: { label: 'this.me', icon: 'badge', href: 'https://neurons-me.github.io/this.me' } },
                  { type: 'link', props: { label: '.GUI', icon: 'widgets', href: 'https://neurons-me.github.io/this.GUI' } },
                  { type: 'link', props: { label: 'GitHub', icon: 'code', href: 'https://github.com/neurons-me' } }
                ]
              },
              children: contentWithHero,
            }
          );
        }

        return contentWithHero;
      }

      function render() {
        const node = React.createElement(App);
        const wrapped = GuiProvider
          ? React.createElement(GuiProvider, { initialMode: 'dark', initialThemeId: 'neurons.me' }, node)
          : node;
        const root = ReactDOM.createRoot(rootEl);
        root.render(wrapped);
      }

      render();
      console.log('[this.me] ✅ index runtime rendered');
    })();
  </script>
</body>
</html>
